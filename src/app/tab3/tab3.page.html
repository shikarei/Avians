<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Insights</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- FILTER + ACTION BUTTONS (1 Row) -->
  <ion-row style="
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  ">

    <!-- Filter Species -->
    <ion-col size="12" size-md="4">
      <ion-item>
        <ion-label>Species</ion-label>
        <ion-select [(ngModel)]="selectedSpecies" (ionChange)="onFilterChange()" okText="Apply" interface="popover">
          <ion-select-option value="__all">All species</ion-select-option>
          <ion-select-option *ngFor="let s of speciesList" [value]="s">
            {{ s }}
          </ion-select-option>
        </ion-select>
      </ion-item>
    </ion-col>

    <!-- Export + Reset -->
    <ion-col size="12" size-md="8" style="
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 6px;
    ">
      <ion-button size="small" (click)="downloadCSV()">
        <ion-icon name="download-outline" slot="start"></ion-icon>
        Export CSV
      </ion-button>

      <ion-button size="small" color="medium" (click)="resetFilter()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Reset
      </ion-button>
    </ion-col>

  </ion-row>


  <!-- Summary Cards -->
  <ion-grid>
    <ion-row>
      <ion-col size="12" size-md="3">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Total Observations</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <h2 style="margin:0;">{{ totalObservations }}</h2>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="3">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Total Birds Counted</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <h2 style="margin:0;">{{ totalBirdsCount }}</h2>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="3">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Unique Species</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <h2 style="margin:0;">{{ uniqueSpecies }}</h2>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="3">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Diversity Index</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <h2 style="margin:0;">{{ diversityIndex | number:'1.2-2' }}</h2>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- top + latest row -->
  <ion-row style="margin-top:6px;">
    <ion-col size="12" size-md="6">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Top 5 Species</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ol>
            <li *ngFor="let item of topSpeciesList">{{ item.name }} — {{ item.count }}</li>
          </ol>
          <p *ngIf="topSpeciesList.length === 0">No data yet.</p>
        </ion-card-content>
      </ion-card>
    </ion-col>

    <ion-col size="12" size-md="6">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Latest Observation</ion-card-title>
        </ion-card-header>
        <ion-card-content *ngIf="latestObservation">
          <p><strong>Species:</strong> {{ latestObservation.species }}</p>
          <p><strong>Date:</strong> {{ latestObservation.date }}</p>
          <p><strong>Count:</strong> {{ latestObservation.count }}</p>
          <p><strong>Observer:</strong> {{ latestObservation.observer }}</p>
          <p><strong>Coordinates:</strong> {{ latestObservation.latitude }}, {{ latestObservation.longitude }}</p>
          <ion-thumbnail *ngIf="latestObservation.photo" style="width:120px; height:80px; margin-top:8px;">
            <img [src]="latestObservation.photo" />
          </ion-thumbnail>
        </ion-card-content>
        <ion-card-content *ngIf="!latestObservation">
          <p>No observations yet.</p>
        </ion-card-content>
      </ion-card>
    </ion-col>
  </ion-row>

  <!-- CHARTS -->
  <ion-card style="margin-top:12px;">
    <ion-card-header>
      <ion-card-title>Observations Per Species</ion-card-title>
    </ion-card-header>
    <ion-card-content style="height: 300px;">
      <canvas id="speciesChart" style="width:100%; height:100%"></canvas>
    </ion-card-content>
  </ion-card>

  <ion-card style="margin-top:12px;">
    <ion-card-header>
      <ion-card-title>Observations Over Time</ion-card-title>
    </ion-card-header>
    <ion-card-content style="height: 300px;">
      <canvas id="timelineChart" style="width:100%; height:100%"></canvas>
    </ion-card-content>
  </ion-card>

  <ion-note style="display:block; margin-top:12px;">
    Data updates in realtime — add, edit, or delete observations to see charts refresh.
  </ion-note>

</ion-content>
